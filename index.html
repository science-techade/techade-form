<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опросный лист по техпроцессу</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Общие стили для динамически добавляемых строк элементов */
        .element-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .element-row input {
            flex: 1;
        }
        .element-row button {
            white-space: nowrap;
        }
        /* Стили для секций анализатора, которые показываются/скрываются */
        .analyzer-section, .conditional-block {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Стили для обязательных полей */
        .required-field::after {
            content: " *";
            color: red;
        }
        /* Стили для контейнера, который используется для генерации PDF (СКРЫТ ДЛЯ ПРОДАКШНА) */
        .pdf-render-container {
            position: fixed;
            top: -9999px; /* Скрываем за пределами экрана */
            left: -9999px;
            width: 210mm; /* Ширина A4 */
            min-height: 297mm; /* Минимальная высота A4 */
            padding: 20mm; /* Отступы для содержимого PDF */
            box-sizing: border-box;
            background: white;
            z-index: -1000; /* За всеми остальными элементами */
            overflow: hidden; /* Скрываем скроллбары */
            opacity: 0; /* Делаем полностью невидимой */
            pointer-events: none; /* Гарантируем отсутствие взаимодействия */
            /* Для временной отладки, если PDF пустой:
            border: 1px solid red;
            opacity: 1;
            top: 0;
            left: 0;
            z-index: 1000;
            */
        }

        /* Стили для статических блоков в PDF */
        .pdf-field-display {
            margin-bottom: 4px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f9f9f9;
            font-size: 13px;
        }
        .pdf-h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.25rem;
            font-weight: 500;
        }
        .pdf-section-title {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .pdf-sub-section-title {
             margin-top: 15px;
             margin-bottom: 8px;
             font-size: 1.1rem;
             font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Опросный лист по техпроцессу</h2>
    <form id="form">
        <div id="pdf-content">
            <div class="mb-4">
                <h5>Основные сведения</h5>
                <div class="mb-3">
                    <label for="date" class="form-label required-field">Дата заполнения опросного листа</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="company" class="form-label required-field">Название компании</label>
                    <input type="text" id="company" name="company" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="contact_person" class="form-label">Контактное лицо</label>
                    <input type="text" id="contact_person" name="contact_person" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Телефон</label>
                    <input type="tel" id="phone" name="phone" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label required-field">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="country" class="form-label">Страна</label>
                    <input type="text" id="country" name="country" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="location" class="form-label">Местонахождение</label>
                    <input type="text" id="location" name="location" class="form-control">
                </div>
            </div>

            <div class="mb-3">
                <label for="material" class="form-label required-field">Тип анализируемого материала</label>
                <select id="material" name="material" class="form-select" required>
                    <option value="">Выберите...</option>
                    <option value="pulp">Пульпа (1–3 потока для анализа)</option>
                    <option value="sinter">Шихта / руда</option>
                    <option value="multiplex">Пульпа с мультиплексором</option>
                    <option value="courier">Пульпа с мультиплексором (на замену анализатора Курьер)</option>
                </select>
            </div>

            <div id="section-pulp" class="analyzer-section">
                <h5>Пульпа: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="pulp_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Характеристика подачи питания</label>
                    <select name="pulp_feed_type" id="feed_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="naporny">Напорный</option>
                        <option value="samotek">Самотек</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Диаметр</label>
                    <input type="text" name="pulp_diameter" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Материал (нерж. сталь, резиновая футеровка и т.д.)</label>
                    <input type="text" name="pulp_material_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление нагнетания / Угол разгрузки</label>
                    <input type="text" name="pulp_pressure_angle" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="pulp_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="pulp_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="pulp_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="pulp_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="pulp_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="pulp_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_pulp" name="xrf_lab_pulp">
                        <label class="form-check-label" for="xrf_lab_pulp">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_pulp" name="personnel_access_pulp">
                        <label class="form-check-label" for="personnel_access_pulp">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_pulp" name="local_network_pulp">
                        <label class="form-check-label" for="local_network_pulp">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_pulp">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_pulp" name="installation_location_pulp">

                        <label class="form-label" for="installation_photo_pulp">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_pulp" name="installation_photo_pulp" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_pulp" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_pulp">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_pulp" name="water_composition_pulp">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_pulp" name="video_surveillance_pulp">
                        <label class="form-check-label" for="video_surveillance_pulp">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-sinter" class="analyzer-section">
                <h5>Шихта / руда: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Рассматриваются анализаторы</label>
                    <select name="sinter_analyzer_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="arp-1c">АРП-1Ц</option>
                        <option value="arp-2c">АРП-2Ц</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Скорость ленты (м/с)</label>
                    <input type="text" name="sinter_belt_speed" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Нагрузка на ленте (тонн/час, мин/макс)</label>
                    <input type="text" name="sinter_belt_load" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="sinter-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('sinter-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="sinter_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="sinter_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="sinter_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в шихте</label>
                    <input type="text" name="sinter_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_sinter" name="xrf_lab_sinter">
                        <label class="form-check-label" for="xrf_lab_sinter">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_sinter" name="personnel_access_sinter">
                        <label class="form-check-label" for="personnel_access_sinter">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_sinter" name="local_network_sinter">
                        <label class="form-check-label" for="local_network_sinter">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_sinter">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_sinter" name="installation_location_sinter">

                        <label class="form-label" for="installation_photo_sinter">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_sinter" name="installation_photo_sinter" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_sinter" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_sinter" name="video_surveillance_sinter">
                        <label class="form-check-label" for="video_surveillance_sinter">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-multiplex" class="analyzer-section">
                <h5>Пульпа с мультиплексором</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="multiplex_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Расстояния между точками</label>
                    <input type="text" name="multiplex_distances" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Тип трубы и её характеристики (диаметр)</label>
                    <input type="text" name="multiplex_pipe_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление в трубопроводе</label>
                    <input type="text" name="multiplex_pressure" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="multiplex_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="multiplex-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="multiplex-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="multiplex_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="multiplex_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="multiplex_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов</label>
                    <input type="text" name="multiplex_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="multiplex_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="multiplex_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_multiplex" name="xrf_lab_multiplex">
                        <label class="form-check-label" for="xrf_lab_multiplex">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_multiplex" name="personnel_access_multiplex">
                        <label class="form-check-label" for="personnel_access_multiplex">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_multiplex" name="local_network_multiplex">
                        <label class="form-check-label" for="local_network_multiplex">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_multiplex">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_multiplex" name="installation_location_multiplex">

                        <label class="form-label" for="installation_photo_multiplex">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_multiplex" name="installation_photo_multiplex" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_multiplex" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_multiplex">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_multiplex" name="water_composition_multiplex">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_multiplex" name="video_surveillance_multiplex">
                        <label class="form-check-label" for="video_surveillance_multiplex">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-courier" class="analyzer-section">
                <h5>Пульпа с мультиплексором (на замену Курьер)</h5>
                <div class="mb-3">
                    <label class="form-label">Наличие существующей системы отбора/доставки проб (Courier, MOG или иная)</label>
                    <input type="text" name="courier_existing_system" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Планируется ли подключение к существующему мультиплексору</label>
                    <input type="text" name="courier_connection_plan" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="courier_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="courier_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="courier-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="courier-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="courier_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="courier_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="courier_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="courier_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="courier_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_courier" name="xrf_lab_courier">
                        <label class="form-check-label" for="xrf_lab_courier">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_courier" name="personnel_access_courier">
                        <label class="form-check-label" for="personnel_access_courier">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_courier" name="local_network_courier">
                        <label class="form-check-label" for="local_network_courier">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_courier">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_courier" name="installation_location_courier">

                        <label class="form-label" for="installation_photo_courier">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_courier" name="installation_photo_courier" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_courier" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_courier">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_courier" name="water_composition_courier">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_courier" name="video_surveillance_courier">
                        <label class="form-check-label" for="video_surveillance_courier">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 mt-4"> 
            <!-- New checkboxes for attachment control -->
            <div class="form-check attachment-checkbox">
                <input class="form-check-input" type="checkbox" id="sendPdf" checked>
                <label class="form-check-label" for="sendPdf">Отправить PDF вложение</label>
            </div>
            
            <button id="submit-button" type="button" class="btn btn-primary">Отправить</button>
        </div>
        <div class="mt-3"> 
            <small class="text-muted"><span style="color: red;">*</span> - обязательные поля</small>
        </div>
    </form>

    <iframe id="pdf-preview" style="width: 100%; height: 500px; margin-top: 20px; display: none;"></iframe>

    <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>

</div>

<script>
    // URL для вашего Google Apps Script Web App.
    // Замените этот placeholder на фактический URL после развертывания скрипта.
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyZ_DnevKiT3qdXRiOC-ezsPRfiJ9mrFkTwVGmWgSwLS9s92cegzrxl7p8ZNApaFb35-Q/exec'; // <--- ОБНОВИТЕ ЭТУ СТРОКУ!

    const dynamicElementData = {};

    function saveDynamicValues(containerId) {
        const data = [];
        document.querySelectorAll(`#${containerId} .element-row`).forEach(row => {
            const inputs = row.querySelectorAll("input");
            if (inputs.length >= 2) {
                data.push({
                    element: inputs[0].value || '',
                    range: inputs[1].value || ''
                });
            }
        });
        dynamicElementData[containerId] = data;
    }

    function restoreDynamicValues(containerId) {
        const container = document.getElementById(containerId);
        if (!dynamicElementData[containerId]) return;

        container.innerHTML = ""; // Очищаем, чтобы восстановить
        dynamicElementData[containerId].forEach(entry => {
            const wrapper = document.createElement("div");
            wrapper.className = "element-row";

            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.placeholder = "Элемент (напр. Fe)";
            inputElement.name = `${containerId}_element[]`;
            inputElement.className = "form-control";
            inputElement.value = entry.element;
            inputElement.oninput = () => saveDynamicValues(containerId);

            const inputRange = document.createElement("input");
            inputRange.type = "text";
            inputRange.placeholder = "Диапазон концентрации";
            inputRange.name = `${containerId}_range[]`;
            inputRange.className = "form-control";
            inputRange.value = entry.range;
            inputRange.oninput = () => saveDynamicValues(containerId);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-outline-danger btn-sm";
            removeBtn.textContent = "Удалить";
            removeBtn.onclick = () => {
                wrapper.remove();
                saveDynamicValues(containerId);
            };

            wrapper.appendChild(inputElement);
            wrapper.appendChild(inputRange);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }

    const containers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"]')).map(el => el.id);

    function showAnalyzerSection(materialType) {
        const sections = document.querySelectorAll('.analyzer-section');
        sections.forEach(section => section.style.display = 'none');

        const selectedSection = document.getElementById(`section-${materialType}`);
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }
    }

    function bindPhotoPreview(materialType) {
        const input = document.getElementById(`installation_photo_${materialType}`);
        const preview = document.getElementById(`installation_preview_${materialType}`);

        if (!input || !preview) return;

        input.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                    input.dataset.jpeg = e.target.result; // Сохраняем Data URL для PDF
                    console.log(`Image Data URL for ${materialType}:`, e.target.result.substring(0, 100) + '...'); // Log a portion of the data URL
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = "none";
                preview.src = "";
                input.dataset.jpeg = ""; // Очищаем Data URL
                console.log(`Image cleared for ${materialType}`);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const materialSelect = document.getElementById("material");
        if (materialSelect) {
            materialSelect.addEventListener("change", () => {
                showAnalyzerSection(materialSelect.value);
                containers.forEach(restoreDynamicValues);
            });
            showAnalyzerSection(materialSelect.value);
            containers.forEach(restoreDynamicValues);
        }

        ["pulp", "sinter", "multiplex", "courier"].forEach(bindPhotoPreview);

        const submitBtn = document.getElementById("submit-button");
        if (submitBtn) {
            submitBtn.addEventListener("click", async (event) => {
                event.preventDefault();
                await submitForm();
            });
        }
    });

    async function blobToBase64(blob) {
        console.log("blobToBase64: Starting conversion.");
        if (!blob) {
            console.error("blobToBase64: Input blob is null or undefined.");
            return null;
        }
        if (!(blob instanceof Blob)) {
            console.error("blobToBase64: Input is not a Blob object. Type:", typeof blob);
            return null;
        }
        console.log("blobToBase64: Blob size:", blob.size, "bytes");

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                console.log("blobToBase64: FileReader result (Data URL start):", reader.result.substring(0, 100) + '...'); // Log start of Data URL
                const base64String = reader.result.split(',')[1];
                if (!base64String) {
                    console.error("blobToBase64: Base64 string is empty or null after splitting.");
                    alert("Ошибка: Не удалось извлечь Base64 строку из PDF Blob.");
                    resolve(null);
                    return;
                }
                console.log("blobToBase64: Conversion complete. Base64 length:", base64String.length);
                resolve(base64String);
            };
            reader.onerror = (error) => {
                console.error("blobToBase64: FileReader error:", error);
                alert(`Ошибка FileReader при конвертации PDF: ${error.message}.`);
                reject(error);
            };
            reader.readAsDataURL(blob);
        });
    }

    // This function is no longer used, as Excel attachment option was removed.
    // Kept for reference but not called.
    function generateExcelBlob() {
        const form = document.getElementById("form");
        const material = form.material.value;
        const dataRows = [];
        const push = (label, val) => dataRows.push([label, val || "—"]);

        push("Дата", form.date.value);
        push("Компания", form.company.value);
        push("Контактное лицо", form.contact_person.value);
        push("Телефон", form.phone.value);
        push("Email", form.email.value);
        push("Страна", form.country.value);
        push("Отчет от", form.location.value);
        push("Тип материала", material);

        const section = document.getElementById(`section-${material}`);
        if (section) {
            section.querySelectorAll("input, select, textarea").forEach(input => {
                if (input.type === "file" || input.tagName === 'BUTTON') return;

                const labelElement = input.closest(".mb-3")?.querySelector("label") || input.closest(".form-check")?.querySelector("label");
                const label = labelElement ? labelElement.textContent?.trim().replace('*', '') : input.name;
                const value = input.type === "checkbox" ? (input.checked ? "Да" : "Нет") : input.value;
                push(label, value);
            });
        }

        const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);

        allDynamicContainers.forEach(id => {
            saveDynamicValues(id);
            const dynamicElements = dynamicElementData[id];
            if (dynamicElements && dynamicElements.length > 0) {
                push(`--- Элементы из ${id} ---`, "");
                dynamicElements.forEach(entry => {
                    push(`Элемент: ${entry.element || '—'}`, `Диапазон: ${entry.range || '—'}`);
                });
            }
        });

        const worksheet = XLSX.utils.aoa_to_sheet(dataRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Опросный лист");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    }

    async function generatePDFBlob() {
        console.log("generatePDFBlob: Starting PDF content generation.");
        const form = document.getElementById("form");
        const materialType = form.material.value;

        // Создаем контейнер, который будет содержать HTML для PDF
        let pdfRenderContainer = document.getElementById('debug-pdf-render-container');
        if (!pdfRenderContainer) {
            pdfRenderContainer = document.createElement('div');
            pdfRenderContainer.id = 'debug-pdf-render-container'; // Добавляем ID для легкого поиска
            pdfRenderContainer.className = 'pdf-render-container';
            document.body.appendChild(pdfRenderContainer);
            console.log("generatePDFBlob: pdfRenderContainer created and appended to body.");
        } else {
            console.log("generatePDFBlob: pdfRenderContainer already exists, reusing.");
        }
        
        pdfRenderContainer.innerHTML = ''; // Очищаем от отладочных сообщений
        console.log("generatePDFBlob: pdfRenderContainer cleared.");

        // Добавляем статическую тестовую строку для отладки рендеринга
        const testParagraph = document.createElement('p');
        testParagraph.textContent = 'Тестовая строка для PDF. Если вы это видите, рендеринг работает.';
        testParagraph.style.color = 'blue';
        testParagraph.style.fontSize = '16px';
        pdfRenderContainer.appendChild(testParagraph);

        // Добавляем заголовок формы
        const formTitle = document.createElement('h2');
        formTitle.className = 'pdf-section-title';
        formTitle.textContent = 'Опросный лист по техпроцессу';
        pdfRenderContainer.appendChild(formTitle);
        console.log("generatePDFBlob: Form title added.");

        // --- Обработка основных сведений ---
        const mainInfoSection = document.createElement('div');
        mainInfoSection.className = 'mb-4';
        const mainInfoTitle = document.createElement('h5');
        mainInfoTitle.className = 'pdf-h5';
        mainInfoTitle.textContent = 'Основные сведения';
        mainInfoSection.appendChild(mainInfoTitle);
        
        const mainFields = [
            { id: 'date', label: 'Дата заполнения опросного листа', type: 'text' },
            { id: 'company', label: 'Название компании', type: 'text' },
            { id: 'contact_person', label: 'Контактное лицо', type: 'text' },
            { id: 'phone', label: 'Телефон', type: 'text' },
            { id: 'email', label: 'Email', type: 'text' },
            { id: 'country', label: 'Страна', type: 'text' },
            { id: 'location', label: 'Местонахождение', type: 'text' }
        ];

        mainFields.forEach(field => {
            const inputElement = document.getElementById(field.id);
            if (inputElement) {
                const displayDiv = document.createElement('div');
                displayDiv.className = 'pdf-field-display';
                displayDiv.innerHTML = `<strong>${field.label.replace('*', '').trim()}:</strong> ${inputElement.value || '—'}`;
                mainInfoSection.appendChild(displayDiv);
            } else {
                console.warn(`generatePDFBlob: Main field element not found: ${field.id}`);
            }
        });
        pdfRenderContainer.appendChild(mainInfoSection);
        console.log("generatePDFBlob: Main info fields processed.");

        // --- Тип анализируемого материала ---
        const materialSelect = document.getElementById('material');
        if (materialSelect) {
            const displayDiv = document.createElement('div');
            displayDiv.className = 'pdf-field-display';
            displayDiv.innerHTML = `<strong>Тип анализируемого материала:</strong> ${materialSelect.options[materialSelect.selectedIndex]?.text || '—'}`;
            pdfRenderContainer.appendChild(displayDiv);
        } else {
            console.warn("generatePDFBlob: Material select element not found.");
        }
        console.log("generatePDFBlob: Material type processed.");

        // --- Обработка секции анализатора ---
        const activeSectionId = `section-${materialType}`;
        const activeSection = document.getElementById(activeSectionId);

        if (activeSection) {
            const sectionTitle = document.createElement('h5');
            sectionTitle.className = 'pdf-section-title';
            sectionTitle.textContent = activeSection.querySelector('h5')?.textContent || 'Детали анализатора';
            pdfRenderContainer.appendChild(sectionTitle);
            console.log(`generatePDFBlob: Active section (${materialType}) title added.`);

            // Собираем все поля из активной секции
            activeSection.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'hidden' || el.tagName === 'BUTTON') {
                    return;
                }

                const displayDiv = document.createElement('div');
                displayDiv.className = 'pdf-field-display';

                const labelElement = el.closest('.mb-3')?.querySelector('label') || el.closest('.form-check')?.querySelector('label');
                const labelText = labelElement ? labelElement.textContent.trim().replace('*', '') : el.name; // Fallback to name if no label

                if (el.type === 'checkbox') {
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${el.checked ? 'Да' : 'Нет'}`;
                } else if (el.type === 'file') {
                    const originalFileInput = document.getElementById(el.id);
                    const fileName = originalFileInput && originalFileInput.files && originalFileInput.files.length > 0 ? originalFileInput.files[0].name : '—';
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${fileName}`;
                    
                    const jpegData = originalFileInput ? originalFileInput.dataset?.jpeg : null;
                    if (jpegData) {
                        const img = document.createElement('img');
                        img.src = jpegData;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.marginTop = '5px';
                        img.style.border = '1px solid #ddd';
                        img.style.pageBreakInside = 'avoid';
                        pdfRenderContainer.appendChild(img);
                        console.log(`generatePDFBlob: Image for ${el.id} added.`);
                    } else {
                        console.log(`generatePDFBlob: No image data for file input ${el.id}`);
                    }
                } else if (el.tagName === 'SELECT') {
                    const originalSelect = document.getElementById(el.id);
                    const selectedText = originalSelect ? originalSelect.options[originalSelect.selectedIndex]?.text : '—';
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${selectedText}`;
                } else {
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${el.value || '—'}`;
                }
                pdfRenderContainer.appendChild(displayDiv);
            });
            console.log("generatePDFBlob: Active section fields processed.");

            // Обработка динамических элементов (Ca до U, легкие элементы)
            activeSection.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"]').forEach(originalDynamicContainer => {
                saveDynamicValues(originalDynamicContainer.id);
                const dynamicElements = dynamicElementData[originalDynamicContainer.id];

                if (dynamicElements && dynamicElements.length > 0) {
                    const dynamicSectionTitle = document.createElement('h5');
                    dynamicSectionTitle.className = 'pdf-sub-section-title';
                    dynamicSectionTitle.textContent = originalDynamicContainer.previousElementSibling?.textContent || 'Элементы';
                    pdfRenderContainer.appendChild(dynamicSectionTitle);
                    console.log(`generatePDFBlob: Dynamic section title added for ${originalDynamicContainer.id}.`);

                    dynamicElements.forEach(entry => {
                        const elementDiv = document.createElement('div');
                        elementDiv.className = 'pdf-field-display';
                        elementDiv.textContent = `Элемент: ${entry.element || '—'}, Диапазон: ${entry.range || '—'}`;
                        pdfRenderContainer.appendChild(elementDiv);
                    });
                    console.log(`generatePDFBlob: Dynamic elements for ${originalDynamicContainer.id} processed.`);
                } else {
                    console.log(`generatePDFBlob: No dynamic elements found for ${originalDynamicContainer.id}.`);
                }
            });
        } else {
            console.warn(`generatePDFBlob: Active section with ID ${activeSectionId} not found.`);
        }
        
        // Логируем HTML-содержимое, которое будет захвачено для PDF
        console.log("generatePDFBlob: InnerHTML of pdfRenderContainer before html2pdf:", pdfRenderContainer.innerHTML.substring(0, 500) + '...');


        // Настройка опций для html2pdf
        const opt = {
            filename: 'oprosny_list.pdf',
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                logging: true,
                // Removed windowWidth and windowHeight as they can cause issues
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' , margin: [10, 10, 10, 10] }, 
            // Removed pagebreak mode to simplify and avoid rendering conflicts
        };

        let pdfBlob = null;
        try {
            console.log("generatePDFBlob: Starting html2pdf generation.");
            // Небольшая задержка, чтобы браузер успел отрендерить контейнер перед захватом
            await new Promise(resolve => setTimeout(resolve, 300));
            pdfBlob = await html2pdf().set(opt).from(pdfRenderContainer).outputPdf('blob');
            console.log("generatePDFBlob: html2pdf generation completed.");
            if (pdfBlob) {
                console.log(`generatePDFBlob: PDF Blob generated! Size: ${pdfBlob.size} bytes.`);
                // alert(`PDF Blob generated! Size: ${pdfBlob.size} bytes. Checking for non-zero size.`); // Keep for user feedback during test
            } else {
                console.error("generatePDFBlob: PDF Blob is NULL! Something went wrong with html2pdf generation.");
                alert("Ошибка: PDF Blob равен NULL. Проверьте консоль на ошибки html2pdf.");
            }
        } catch (error) {
            console.error("generatePDFBlob: Error during html2pdf generation:", error);
            alert(`Ошибка при генерации PDF: ${error.message}. Проверьте консоль.`);
            return null;
        } finally {
            // Удаляем временный контейнер после генерации PDF
            if (document.body.contains(pdfRenderContainer)) {
                document.body.removeChild(pdfRenderContainer);
                console.log("generatePDFBlob: pdfRenderContainer removed from DOM.");
            }
        }
        return pdfBlob;
    }

    async function sendToGoogleSheet(formData, pdfBase64, installationPhotoDataUrl) {
        if (!GOOGLE_SHEET_WEB_APP_URL) {
            console.error("GOOGLE_SHEET_WEB_APP_URL не установлен. Отправка в Google Sheet пропущена. Пожалуйста, обновите URL в коде Canvas.");
            alert("Ошибка: URL для Google Таблицы не настроен. Пожалуйста, обновите код Canvas с правильным URL веб-приложения Google Apps Script.");
            return;
        }
        console.log("sendToGoogleSheet: Attempting to send data to Google Sheet.");

        const payload = {
            ...formData,
            pdf_attachment_base64: pdfBase64 || '', 
            installation_photo_base64: installationPhotoDataUrl || ''
        };

        try {
            console.log("sendToGoogleSheet: Sending data:", payload);
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                // УДАЛЕНО: mode: 'no-cors' - это было причиной проблем с данными
            });

            console.log("sendToGoogleSheet: Request sent. Response:", response);
            alert("Данные отправлены!");

        } catch (error) {
            console.error("sendToGoogleSheet: Error sending to Google Sheet:", error);
            alert("Ошибка при отправке данных. Проверьте подключение к интернету или попробуйте позже.");
        }
    }

    async function submitForm() {
        console.log("submitForm: Function started.");
        const form = document.getElementById("form");
        const emailInput = form.email;
        const materialSelect = form.material;
        const errorMessageDiv = document.getElementById("error-message");
        const sendPdfCheckbox = document.getElementById("sendPdf");

        errorMessageDiv.style.display = 'none';
        errorMessageDiv.textContent = '';
        emailInput.classList.remove('is-invalid');
        materialSelect.classList.remove('is-invalid');

        if (!form.checkValidity()) {
            errorMessageDiv.textContent = "Пожалуйста, заполните все обязательные поля формы.";
            errorMessageDiv.style.display = 'block';
            form.reportValidity();
            console.log("submitForm: Form validation failed.");
            return;
        }
        console.log("submitForm: Form validation passed.");

        const email = emailInput.value;
        const material = materialSelect.value;

        let pdfBase64 = null;
        let installationPhotoDataUrl = null; 
        let formDataForGoogleSheet = {};

        try {
            // Collect general form data
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name && element.type !== 'file' && element.tagName !== 'BUTTON' && element.type !== 'checkbox' && element.type !== 'hidden') {
                    formDataForGoogleSheet[element.name] = element.value;
                } else if (element.type === 'checkbox' && element.name) {
                    formDataForGoogleSheet[element.name] = element.checked;
                }
            }
            console.log("submitForm: General form data collected.");

            // Get dynamic elements data
            const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);
            allDynamicContainers.forEach(id => {
                saveDynamicValues(id); // Ensure latest dynamic values are saved
                const dynamicElements = dynamicElementData[id];
                if (dynamicElements && dynamicElements.length > 0) {
                    // Store as stringified JSON to save in one cell in Google Sheet
                    formDataForGoogleSheet[id] = JSON.stringify(dynamicElements); 
                }
            });
            console.log("submitForm: Dynamic elements data collected.");

            // Get the current material type to retrieve the correct photo data
            const currentMaterialSection = document.querySelector(`.analyzer-section[style*="block"]`);
            if (currentMaterialSection) {
                const photoInput = currentMaterialSection.querySelector('input[type="file"]');
                if (photoInput && photoInput.dataset.jpeg) {
                    installationPhotoDataUrl = photoInput.dataset.jpeg;
                    console.log("submitForm: Photo Data URL to be sent:", installationPhotoDataUrl.substring(0, 100) + '...');
                } else {
                    console.log("submitForm: No photo data or photo input found for current section.");
                }
            } else {
                console.warn("submitForm: No active material section found.");
            }

            // Generate PDF if selected
            if (sendPdfCheckbox.checked) {
                console.log("submitForm: sendPdfCheckbox is checked. Calling generatePDFBlob.");
                pdfBase64 = await generatePDFBlob();
                if (pdfBase64) {
                    console.log("submitForm: PDF Base64 generated. Length:", pdfBase64.length);
                } else {
                    console.error("submitForm: PDF generation failed or returned null or undefined. PDF will not be attached.");
                    alert("Внимание: PDF-файл не был сгенерирован или был пустым. Он не будет прикреплен к письму.");
                }
            } else {
                console.log("submitForm: sendPdfCheckbox is NOT checked. Skipping PDF generation.");
            }
            
            // --- Отправка в Google Sheet ---
            // Собираем все данные для Google Sheet.
            const googleSheetPayload = {
                // Основные поля
                date: form.date.value || '',
                company: form.company.value || '',
                contact_person: form.contact_person.value || '',
                phone: form.phone.value || '',
                email: email, // Используем email напрямую
                country: form.country.value || '',
                location: form.location.value || '',
                material_type: material, 
                
                // Динамические элементы
                'elements-ca-u': formDataForGoogleSheet['elements-ca-u'] || '',
                'light-elements': formDataForGoogleSheet['light-elements'] || '',
                'sinter-elements-ca-u': formDataForGoogleSheet['sinter-elements-ca-u'] || '',
                'multiplex-elements-ca-u': formDataForGoogleSheet['multiplex-elements-ca-u'] || '',
                'multiplex-light-elements': formDataForGoogleSheet['multiplex-light-elements'] || '',
                'courier-elements-ca-u': formDataForGoogleSheet['courier-elements-ca-u'] || '',
                'courier-light-elements': formDataForGoogleSheet['courier-light-elements'] || '',

                // Поля специфичных секций (например, pulp_streams)
                // Собираем данные из активной секции
                ...Object.fromEntries(
                    Array.from(currentMaterialSection ? currentMaterialSection.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), select, textarea') : []).map(el => [el.name, el.value])
                ),
                // Чекбоксы из активной секции
                ...Object.fromEntries(
                    Array.from(currentMaterialSection ? currentMaterialSection.querySelectorAll('input[type="checkbox"]') : []).map(el => [el.name, el.checked ? 'Да' : 'Нет'])
                ),
                
                // Base64 вложения
                pdf_attachment_base64: pdfBase64 || '', 
                installation_photo_base64: installationPhotoDataUrl || ''
            };

            await sendToGoogleSheet(googleSheetPayload, pdfBase64, installationPhotoDataUrl);
            console.log("submitForm: sendToGoogleSheet called.");

        } catch (err) {
            console.error("submitForm: Критическая ошибка при отправке формы:", err);
            errorMessageDiv.textContent = `Критическая ошибка: ${err.message || "Неизвестная ошибка."} Пожалуйста, попробуйте еще раз или обратитесь в поддержку.`;
            errorMessageDiv.style.display = 'block';
        }
    }

    function addElementRow(containerId) {
        const container = document.getElementById(containerId);
        const wrapper = document.createElement("div");
        wrapper.className = "element-row";

        const inputElement = document.createElement("input");
        inputElement.type = "text";
        inputElement.placeholder = "Элемент (напр. Fe)";
        inputElement.name = `${containerId}_element[]`;
        inputElement.className = "form-control";
        inputElement.value = "";
        inputElement.oninput = () => saveDynamicValues(containerId);

        const inputRange = document.createElement("input");
        inputRange.type = "text";
        inputRange.placeholder = "Диапазон концентрации";
        inputRange.name = `${containerId}_range[]`;
        inputRange.className = "form-control";
        inputRange.value = "";
        inputRange.oninput = () => saveDynamicValues(containerId);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn btn-outline-danger btn-sm";
        removeBtn.textContent = "Удалить";
        removeBtn.onclick = () => {
            wrapper.remove();
            saveDynamicValues(containerId);
        };

        wrapper.appendChild(inputElement);
        wrapper.appendChild(inputRange);
        wrapper.appendChild(removeBtn);
        container.appendChild(wrapper);

        saveDynamicValues(containerId);
    }

    window.addElementRow = addElementRow;
</script>
</body>
</html>
