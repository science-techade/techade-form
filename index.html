<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-1">
    <title>Опросный лист по техпроцессу</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Общие стили для динамически добавляемых строк элементов */
        .element-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .element-row input {
            flex: 1;
        }
        .element-row button {
            white-space: nowrap;
        }
        /* Стили для секций анализатора, которые показываются/скрываются */
        .analyzer-section, .conditional-block {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Стили для обязательных полей */
        .required-field::after {
            content: " *";
            color: red;
        }
        /* Класс для элементов, которые должны быть невидимыми только при генерации PDF */
        /* Этот класс будет добавляться/удаляться динамически, он не должен быть жестко применен в HTML */
        .pdf-hide {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Опросный лист по техпроцессу</h2>
    <form id="form">
        <div id="pdf-content">
            <input type="hidden" name="pdf_data" id="pdf_data">
            <div class="mb-4">
                <h5>Основные сведения</h5>
                <div class="mb-3">
                    <label for="date" class="form-label required-field">Дата заполнения опросного листа</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="company" class="form-label required-field">Название компании</label>
                    <input type="text" id="company" name="company" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="contact_person" class="form-label">Контактное лицо</label>
                    <input type="text" id="contact_person" name="contact_person" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Телефон</label>
                    <input type="tel" id="phone" name="phone" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label required-field">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="country" class="form-label">Страна</label>
                    <input type="text" id="country" name="country" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="location" class="form-label">Местонахождение</label>
                    <input type="text" id="location" name="location" class="form-control">
                </div>
            </div>

            <div class="mb-3">
                <label for="material" class="form-label required-field">Тип анализируемого материала</label>
                <select id="material" name="material" class="form-select" required>
                    <option value="">Выберите...</option>
                    <option value="pulp">Пульпа (1–3 потока для анализа)</option>
                    <option value="sinter">Шихта / руда</option>
                    <option value="multiplex">Пульпа с мультиплексором</option>
                    <option value="courier">Пульпа с мультиплексором (на замену анализатора Курьер)</option>
                </select>
            </div>

            <div id="section-pulp" class="analyzer-section">
                <h5>Пульпа: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="pulp_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Характеристика подачи питания</label>
                    <select name="pulp_feed_type" id="feed_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="naporny">Напорный</option>
                        <option value="samotek">Самотек</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Диаметр</label>
                    <input type="text" name="pulp_diameter" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Материал (нерж. сталь, резиновая футеровка и т.д.)</label>
                    <input type="text" name="pulp_material_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление нагнетания / Угол разгрузки</label>
                    <input type="text" name="pulp_pressure_angle" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="pulp_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="pulp_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="pulp_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="pulp_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="pulp_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="pulp_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_pulp" name="xrf_lab_pulp">
                        <label class="form-check-label" for="xrf_lab_pulp">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_pulp" name="personnel_access_pulp">
                        <label class="form-check-label" for="personnel_access_pulp">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_pulp" name="local_network_pulp">
                        <label class="form-check-label" for="local_network_pulp">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_pulp">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_pulp" name="installation_location_pulp">

                        <label class="form-label" for="installation_photo_pulp">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_pulp" name="installation_photo_pulp" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_pulp" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_pulp">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_pulp" name="water_composition_pulp">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_pulp" name="video_surveillance_pulp">
                        <label class="form-check-label" for="video_surveillance_pulp">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-sinter" class="analyzer-section">
                <h5>Шихта / руда: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Рассматриваются анализаторы</label>
                    <select name="sinter_analyzer_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="arp-1c">АРП-1Ц</option>
                        <option value="arp-2c">АРП-2Ц</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Скорость ленты (м/с)</label>
                    <input type="text" name="sinter_belt_speed" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Нагрузка на ленте (тонн/час, мин/макс)</label>
                    <input type="text" name="sinter_belt_load" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="sinter-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('sinter-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="sinter_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="sinter_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="sinter_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в шихте</label>
                    <input type="text" name="sinter_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_sinter" name="xrf_lab_sinter">
                        <label class="form-check-label" for="xrf_lab_sinter">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_sinter" name="personnel_access_sinter">
                        <label class="form-check-label" for="personnel_access_sinter">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_sinter" name="local_network_sinter">
                        <label class="form-check-label" for="local_network_sinter">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_sinter">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_sinter" name="installation_location_sinter">

                        <label class="form-label" for="installation_photo_sinter">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_sinter" name="installation_photo_sinter" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_sinter" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_sinter" name="video_surveillance_sinter">
                        <label class="form-check-label" for="video_surveillance_sinter">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-multiplex" class="analyzer-section">
                <h5>Пульпа с мультиплексором</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="multiplex_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Расстояния между точками</label>
                    <input type="text" name="multiplex_distances" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Тип трубы и её характеристики (диаметр)</label>
                    <input type="text" name="multiplex_pipe_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление в трубопроводе</label>
                    <input type="text" name="multiplex_pressure" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="multiplex_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="multiplex-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="multiplex-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="multiplex_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="multiplex_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="multiplex_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов</label>
                    <input type="text" name="multiplex_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="multiplex_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="multiplex_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_multiplex" name="xrf_lab_multiplex">
                        <label class="form-check-label" for="xrf_lab_multiplex">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_multiplex" name="personnel_access_multiplex">
                        <label class="form-check-label" for="personnel_access_multiplex">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_multiplex" name="local_network_multiplex">
                        <label class="form-check-label" for="local_network_multiplex">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_multiplex">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_multiplex" name="installation_location_multiplex">

                        <label class="form-label" for="installation_photo_multiplex">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_multiplex" name="installation_photo_multiplex" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_multiplex" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_multiplex">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_multiplex" name="water_composition_multiplex">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_multiplex" name="video_surveillance_multiplex">
                        <label class="form-check-label" for="video_surveillance_multiplex">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-courier" class="analyzer-section">
                <h5>Пульпа с мультиплексором (на замену Курьер)</h5>
                <div class="mb-3">
                    <label class="form-label">Наличие существующей системы отбора/доставки проб (Courier, MOG или иная)</label>
                    <input type="text" name="courier_existing_system" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Планируется ли подключение к существующему мультиплексору</label>
                    <input type="text" name="courier_connection_plan" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="courier_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="courier_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="courier-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="courier-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="courier_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="courier_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="courier_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="courier_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="courier_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_courier" name="xrf_lab_courier">
                        <label class="form-check-label" for="xrf_lab_courier">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_courier" name="personnel_access_courier">
                        <label class="form-check-label" for="personnel_access_courier">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_courier" name="local_network_courier">
                        <label class="form-check-label" for="local_network_courier">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_courier">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_courier" name="installation_location_courier">

                        <label class="form-label" for="installation_photo_courier">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_courier" name="installation_photo_courier" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_courier" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_courier">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_courier" name="water_composition_courier">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_courier" name="video_surveillance_courier">
                        <label class="form-check-label" for="video_surveillance_courier">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 mt-4"> 
            <!-- New checkboxes for attachment control -->
            <div class="form-check attachment-checkbox">
                <input class="form-check-input" type="checkbox" id="sendPdf" checked>
                <label class="form-check-label" for="sendPdf">Отправить PDF вложение</label>
            </div>
            
            <button id="submit-button" type="button" class="btn btn-primary">Отправить</button>
        </div>
        <div class="mt-3"> 
            <small class="text-muted"><span style="color: red;">*</span> - обязательные поля</small>
        </div>
    </form>

    <iframe id="pdf-preview" style="width: 100%; height: 500px; margin-top: 20px; display: none;"></iframe>

    <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>

</div>

<script>
    // URL для вашего Google Apps Script Web App.
    // Замените этот placeholder на фактический URL после развертывания скрипта.
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx7Pa7xOUkG5PrmZD-FtCyO8zgtXPjOcO4KMDm4fLQdOV6v3MIVSksZNAEVgRqm1wpF4w/exec'; // <--- ОБНОВИТЕ ЭТУ СТРОКУ!

    const dynamicElementData = {};

    function saveDynamicValues(containerId) {
        const data = [];
        document.querySelectorAll(`#${containerId} .element-row`).forEach(row => {
            const inputs = row.querySelectorAll("input");
            if (inputs.length >= 2) {
                data.push({
                    element: inputs[0].value || '',
                    range: inputs[1].value || ''
                });
            }
        });
        dynamicElementData[containerId] = data;
    }

    function restoreDynamicValues(containerId) {
        const container = document.getElementById(containerId);
        if (!dynamicElementData[containerId]) return;

        container.innerHTML = ""; // Очищаем, чтобы восстановить
        dynamicElementData[containerId].forEach(entry => {
            const wrapper = document.createElement("div");
            wrapper.className = "element-row";

            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.placeholder = "Элемент (напр. Fe)";
            inputElement.name = `${containerId}_element[]`;
            inputElement.className = "form-control";
            inputElement.value = entry.element;
            inputElement.oninput = () => saveDynamicValues(containerId);

            const inputRange = document.createElement("input");
            inputRange.type = "text";
            inputRange.placeholder = "Диапазон концентрации";
            inputRange.name = `${containerId}_range[]`;
            inputRange.className = "form-control";
            inputRange.value = entry.range;
            inputRange.oninput = () => saveDynamicValues(containerId);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-outline-danger btn-sm";
            removeBtn.textContent = "Удалить";
            removeBtn.onclick = () => {
                wrapper.remove();
                saveDynamicValues(containerId);
            };

            wrapper.appendChild(inputElement);
            wrapper.appendChild(inputRange);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
        });
    }

    const containers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"]')).map(el => el.id);

    function showAnalyzerSection(materialType) {
        const sections = document.querySelectorAll('.analyzer-section');
        sections.forEach(section => section.style.display = 'none');

        const selectedSection = document.getElementById(`section-${materialType}`);
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }
    }

    function bindPhotoPreview(materialType) {
        const input = document.getElementById(`installation_photo_${materialType}`);
        const preview = document.getElementById(`installation_preview_${materialType}`);

        if (!input || !preview) return;

        input.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                    input.dataset.jpeg = e.target.result; // Сохраняем Data URL для PDF
                    console.log(`Image Data URL for ${materialType}:`, e.target.result.substring(0, 100) + '...'); // Log a portion of the data URL
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = "none";
                preview.src = "";
                input.dataset.jpeg = ""; // Очищаем Data URL
                console.log(`Image cleared for ${materialType}`);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const materialSelect = document.getElementById("material");
        if (materialSelect) {
            materialSelect.addEventListener("change", () => {
                showAnalyzerSection(materialSelect.value);
                containers.forEach(restoreDynamicValues);
            });
            showAnalyzerSection(materialSelect.value);
            containers.forEach(restoreDynamicValues);
        }

        ["pulp", "sinter", "multiplex", "courier"].forEach(bindPhotoPreview);

        const submitBtn = document.getElementById("submit-button");
        if (submitBtn) {
            submitBtn.addEventListener("click", async (event) => {
                event.preventDefault();
                await submitForm();
            });
        }
    });

    async function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = (error) => { // Added error handling for FileReader
                console.error("FileReader error:", error);
                reject(error);
            };
            reader.readAsDataURL(blob);
        });
    }

    // This function is no longer used, as Excel attachment option was removed.
    // Kept for reference but not called.
    function generateExcelBlob() {
        const form = document.getElementById("form");
        const material = form.material.value;
        const dataRows = [];
        const push = (label, val) => dataRows.push([label, val || "—"]);

        push("Дата", form.date.value);
        push("Компания", form.company.value);
        push("Контактное лицо", form.contact_person.value);
        push("Телефон", form.phone.value);
        push("Email", form.email.value);
        push("Страна", form.country.value);
        push("Отчет от", form.location.value);
        push("Тип материала", material);

        const section = document.getElementById(`section-${material}`);
        if (section) {
            section.querySelectorAll("input, select, textarea").forEach(input => {
                if (input.type === "file" || input.tagName === 'BUTTON') return;

                const labelElement = input.closest(".mb-3")?.querySelector("label") || input.closest(".form-check")?.querySelector("label");
                const label = labelElement ? labelElement.textContent?.trim().replace('*', '') : input.name;
                const value = input.type === "checkbox" ? (input.checked ? "Да" : "Нет") : input.value;
                push(label, value);
            });
        }

        const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);

        allDynamicContainers.forEach(id => {
            saveDynamicValues(id);
            const dynamicElements = dynamicElementData[id];
            if (dynamicElements && dynamicElements.length > 0) {
                push(`--- Элементы из ${id} ---`, "");
                dynamicElements.forEach(entry => {
                    push(`Элемент: ${entry.element || '—'}`, `Диапазон: ${entry.range || '—'}`);
                });
            }
        });

        const worksheet = XLSX.utils.aoa_to_sheet(dataRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Опросный лист");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    }

    async function generatePDFBlob() {
        const pdfContentOriginal = document.getElementById("pdf-content");
        const pdfContentClone = pdfContentOriginal.cloneNode(true); // Глубокое клонирование

        // Скрываем кнопки добавления/удаления элементов в клоне
        pdfContentClone.querySelectorAll('.element-row button, .btn-outline-primary').forEach(button => {
            button.remove(); // Удаляем кнопки из клона
        });
        
        // Убеждаемся, что только выбранная секция анализатора видна в клоне
        const materialType = document.getElementById('material').value;
        pdfContentClone.querySelectorAll('.analyzer-section').forEach(section => {
            if (section.id !== `section-${materialType}`) {
                section.style.display = 'none';
            }
        });

        // Обрабатываем поля формы в клоне: заменяем их статическим текстом
        pdfContentClone.querySelectorAll('input, select, textarea').forEach(el => {
            // Исключаем скрытые поля, которые не должны отображаться в PDF
            if (el.type === 'hidden') {
                el.remove();
                return;
            }

            const wrapperDiv = el.closest('.mb-3') || el.closest('.form-check'); // Находим родительский div для замены
            if (!wrapperDiv) {
                // Если нет родительского .mb-3 или .form-check, просто заменим сам элемент
                const tempDiv = document.createElement('div');
                tempDiv.textContent = el.value || '—';
                el.replaceWith(tempDiv);
                return;
            }
            
            const labelElement = wrapperDiv.querySelector('label');
            const labelText = labelElement ? labelElement.textContent.trim().replace('*', '') : '';
            let displayValue = '';

            if (el.type === 'checkbox') {
                displayValue = el.checked ? 'Да' : 'Нет';
                // Заменяем весь form-check div
                const newContentDiv = document.createElement('div');
                newContentDiv.style.marginBottom = "4px";
                newContentDiv.style.padding = "4px 8px";
                newContentDiv.style.border = "1px solid #ccc";
                newContentDiv.style.borderRadius = "3px";
                newContentDiv.style.backgroundColor = "#f9f9f9";
                newContentDiv.style.fontSize = "13px";
                newContentDiv.innerHTML = `<strong>${labelText}:</strong> ${displayValue}`;
                wrapperDiv.replaceWith(newContentDiv);

            } else if (el.type === 'file') {
                const previewImg = wrapperDiv.querySelector('img');
                const jpegData = el.dataset?.jpeg;

                // Создаем div для отображения имени файла (если выбран)
                const fileDisplayDiv = document.createElement('div');
                fileDisplayDiv.style.marginBottom = "4px";
                fileDisplayDiv.style.padding = "4px 8px";
                fileDisplayDiv.style.border = "1px solid #ccc";
                fileDisplayDiv.style.borderRadius = "3px";
                fileDisplayDiv.style.backgroundColor = "#f9f9f9";
                fileDisplayDiv.style.fontSize = "13px";

                if (el.files && el.files.length > 0) {
                    fileDisplayDiv.innerHTML = `<strong>${labelText}:</strong> ${el.files[0].name}`;
                } else {
                    fileDisplayDiv.innerHTML = `<strong>${labelText}:</strong> —`;
                }
                
                // Вставляем div с именем файла перед оригинальным блоком
                wrapperDiv.parentElement.insertBefore(fileDisplayDiv, wrapperDiv);

                // Если есть изображение, добавляем его после div с именем файла
                if (jpegData) {
                    const img = document.createElement("img");
                    img.src = jpegData;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    img.style.marginTop = "5px";
                    img.style.border = "1px solid #ddd";
                    img.style.pageBreakInside = 'avoid';
                    wrapperDiv.parentElement.insertBefore(img, wrapperDiv); // Добавляем изображение
                }

                wrapperDiv.remove(); // Удаляем оригинальный блок с файловым полем, лейблом и превью
            } else if (el.tagName === 'SELECT') {
                displayValue = el.options[el.selectedIndex]?.text || '—';
                const newContentDiv = document.createElement('div');
                newContentDiv.style.marginBottom = "4px";
                newContentDiv.style.padding = "4px 8px";
                newContentDiv.style.border = "1px solid #ccc";
                newContentDiv.style.borderRadius = "3px";
                newContentDiv.style.backgroundColor = "#f9f9f9";
                newContentDiv.style.fontSize = "13px";
                newContentDiv.innerHTML = `<strong>${labelText}:</strong> ${displayValue}`;
                wrapperDiv.replaceWith(newContentDiv);
            } else { // Для текстовых полей и чисел
                displayValue = el.value || '—';
                const newContentDiv = document.createElement('div');
                newContentDiv.style.marginBottom = "4px";
                newContentDiv.style.padding = "4px 8px";
                newContentDiv.style.border = "1px solid #ccc";
                newContentDiv.style.borderRadius = "3px";
                newContentDiv.style.backgroundColor = "#f9f9f9";
                newContentDiv.style.fontSize = "13px";
                newContentDiv.innerHTML = `<strong>${labelText}:</strong> ${displayValue}`;
                wrapperDiv.replaceWith(newContentDiv);
            }
        });

        // Дополнительная обработка для динамических элементов (которые добавляются кнопкой)
        // Они уже должны быть вложены в clone, но нужно удалить их кнопки
        pdfContentClone.querySelectorAll('.element-row button').forEach(button => button.remove());


        const wrapper = document.createElement("div");
        // Эти стили делают обертку невидимой и вне потока документа,
        // чтобы она не влияла на макет, пока html2pdf делает снимок.
        wrapper.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 210mm; /* Ширина A4 для рендеринга */
            height: 297mm; /* Высота A4 для рендеринга */
            padding: 20mm; /* Отступы для содержимого PDF */
            box-sizing: border-box;
            background: white;
            opacity: 0; /* Делаем полностью невидимой */
            pointer-events: none; /* Гарантируем отсутствие взаимодействия */
            z-index: -1000; /* За всеми остальными элементами */
            overflow: auto; /* Позволяем содержимому прокручиваться внутри обертки, html2pdf будет обрабатывать страницы */
        `;
        wrapper.appendChild(pdfContentClone); // Добавляем обработанную копию формы
        document.body.appendChild(wrapper); // Добавляем обертку в DOM

        const opt = {
            filename: 'oprosny_list.pdf',
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                logging: true, // Включаем логирование для отладки
                windowWidth: pdfContentClone.scrollWidth, // Захват полной ширины контента
                windowHeight: pdfContentClone.scrollHeight // Захват полной высоты контента
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' , margin: [10, 10, 10, 10] }, 
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        let pdfBlob;
        try {
            // Небольшая задержка, чтобы браузер успел отрендерить невидимую обертку
            await new Promise(resolve => setTimeout(resolve, 300));
            pdfBlob = await html2pdf().set(opt).from(wrapper).outputPdf('blob');
        } finally {
            // Удаляем временную обертку из DOM после генерации PDF
            if (document.body.contains(wrapper)) {
                document.body.removeChild(wrapper);
            }
        }
        return pdfBlob;
    }

    async function sendToGoogleSheet(formData, pdfBase64, installationPhotoDataUrl) {
        // Проверка и сообщение, если URL не установлен
        if (!GOOGLE_SHEET_WEB_APP_URL || GOOGLE_SHEET_WEB_APP_URL === 'https://script.google.com/macros/s/AKfycbx7Pa7xOUkG5PrmZD-FtCyO8zgtXPjOcO4KMDm4fLQdOV6v3MIVSksZNAEVgRqm1wpF4w/exec') {
            console.error("GOOGLE_SHEET_WEB_APP_URL не установлен. Отправка в Google Sheet пропущена. Пожалуйста, обновите URL в коде Canvas.");
            alert("Ошибка: URL для Google Таблицы не настроен. Пожалуйста, обновите код Canvas с правильным URL веб-приложения Google Apps Script.");
            return;
        }

        const payload = {
            ...formData,
            pdf_attachment_base64: pdfBase64 || '',
            installation_photo_base64: installationPhotoDataUrl || ''
        };

        try {
            console.log("Отправка данных в Google Sheet:", payload);
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
                mode: 'no-cors'
            });

            console.log("Запрос в Google Sheet отправлен. Ответ (может быть пустым из-за no-cors mode):", response);
            alert("Данные отправлены!");

        } catch (error) {
            console.error("Ошибка при отправке в Google Sheet:", error);
            alert("Ошибка при отправке данных. Проверьте подключение к интернету или попробуйте позже."); // Более общее сообщение об ошибке
        }
    }

    async function submitForm() {
        const form = document.getElementById("form");
        const emailInput = form.email;
        const materialSelect = form.material;
        const errorMessageDiv = document.getElementById("error-message");
        const sendPdfCheckbox = document.getElementById("sendPdf");

        errorMessageDiv.style.display = 'none';
        errorMessageDiv.textContent = '';
        emailInput.classList.remove('is-invalid');
        materialSelect.classList.remove('is-invalid');

        if (!form.checkValidity()) {
            errorMessageDiv.textContent = "Пожалуйста, заполните все обязательные поля формы.";
            errorMessageDiv.style.display = 'block';
            form.reportValidity();
            return;
        }

        const email = emailInput.value;
        const material = materialSelect.value;

        let pdfBase64 = null;
        let installationPhotoDataUrl = null; 
        let formDataForGoogleSheet = {};

        try {
            // Collect general form data
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name && element.type !== 'file' && element.tagName !== 'BUTTON' && element.type !== 'checkbox' && element.type !== 'hidden') {
                    formDataForGoogleSheet[element.name] = element.value;
                } else if (element.type === 'checkbox' && element.name) {
                    formDataForGoogleSheet[element.name] = element.checked;
                }
            }

            // Get dynamic elements data
            const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);
            allDynamicContainers.forEach(id => {
                saveDynamicValues(id); // Ensure latest dynamic values are saved
                const dynamicElements = dynamicElementData[id];
                if (dynamicElements && dynamicElements.length > 0) {
                    // Store as stringified JSON to save in one cell in Google Sheet
                    formDataForGoogleSheet[id] = JSON.stringify(dynamicElements); 
                }
            });

            // Get the current material type to retrieve the correct photo data
            const currentMaterialSection = document.querySelector(`.analyzer-section[style*="block"]`);
            if (currentMaterialSection) {
                const photoInput = currentMaterialSection.querySelector('input[type="file"]');
                if (photoInput && photoInput.dataset.jpeg) {
                    installationPhotoDataUrl = photoInput.dataset.jpeg;
                    console.log("Photo Data URL to be sent:", installationPhotoDataUrl.substring(0, 100) + '...');
                }
            }

            // Generate PDF if selected
            if (sendPdfCheckbox.checked) {
                const pdfBlob = await generatePDFBlob();
                pdfBase64 = await blobToBase64(pdfBlob);
                console.log("PDF Base64 generated. Length:", pdfBase64 ? pdfBase64.length : 0);
                if (!pdfBase64 || pdfBase64.length < 100) { // Простая проверка на минимальную длину
                    console.error("Сгенерированный PDF Base64 кажется слишком коротким или пустым.");
                }
            }
            
            // --- Отправка в Google Sheet ---
            // Собираем все данные для Google Sheet.
            const googleSheetPayload = {
                // Основные поля
                date: form.date.value || '',
                company: form.company.value || '',
                contact_person: form.contact_person.value || '',
                phone: form.phone.value || '',
                email: email, // Используем email напрямую
                country: form.country.value || '',
                location: form.location.value || '',
                material_type: material, 
                
                // Динамические элементы
                'elements-ca-u': formDataForGoogleSheet['elements-ca-u'] || '',
                'light-elements': formDataForGoogleSheet['light-elements'] || '',
                'sinter-elements-ca-u': formDataForGoogleSheet['sinter-elements-ca-u'] || '',
                'multiplex-elements-ca-u': formDataForGoogleSheet['multiplex-elements-ca-u'] || '',
                'multiplex-light-elements': formDataForGoogleSheet['multiplex-light-elements'] || '',
                'courier-elements-ca-u': formDataForGoogleSheet['courier-elements-ca-u'] || '',
                'courier-light-elements': formDataForGoogleSheet['courier-light-elements'] || '',

                // Поля специфичных секций (например, pulp_streams)
                // Собираем данные из активной секции
                ...Object.fromEntries(
                    Array.from(currentMaterialSection.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), select, textarea')).map(el => [el.name, el.value])
                ),
                // Чекбоксы из активной секции
                ...Object.fromEntries(
                    Array.from(currentMaterialSection.querySelectorAll('input[type="checkbox"]')).map(el => [el.name, el.checked ? 'Да' : 'Нет'])
                ),
                
                // Base64 вложения
                pdf_attachment_base64: pdfBase64 || '',
                installation_photo_base64: installationPhotoDataUrl || ''
            };

            await sendToGoogleSheet(googleSheetPayload, pdfBase64, installationPhotoDataUrl);

        } catch (err) {
            console.error("Критическая ошибка при отправке формы:", err);
            errorMessageDiv.textContent = `Критическая ошибка: ${err.message || "Неизвестная ошибка."} Пожалуйста, попробуйте еще раз или обратитесь в поддержку.`;
            errorMessageDiv.style.display = 'block';
        }
    }

    function addElementRow(containerId) {
        const container = document.getElementById(containerId);
        const wrapper = document.createElement("div");
        wrapper.className = "element-row";

        const inputElement = document.createElement("input");
        inputElement.type = "text";
        inputElement.placeholder = "Элемент (напр. Fe)";
        inputElement.name = `${containerId}_element[]`;
        inputElement.className = "form-control";
        inputElement.value = "";
        inputElement.oninput = () => saveDynamicValues(containerId);

        const inputRange = document.createElement("input");
        inputRange.type = "text";
        inputRange.placeholder = "Диапазон концентрации";
        inputRange.name = `${containerId}_range[]`;
        inputRange.className = "form-control";
        inputRange.value = "";
        inputRange.oninput = () => saveDynamicValues(containerId);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn btn-outline-danger btn-sm";
        removeBtn.textContent = "Удалить";
        removeBtn.onclick = () => {
            wrapper.remove();
            saveDynamicValues(containerId);
        };

        wrapper.appendChild(inputElement);
        wrapper.appendChild(inputRange);
        wrapper.appendChild(removeBtn);
        container.appendChild(wrapper);

        saveDynamicValues(containerId);
    }

    window.addElementRow = addElementRow;
</script>
</body>
</html>
