<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опросный лист по техпроцессу</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        // Инициализация EmailJS с вашим публичным ключом.
        // Замените 'YOUR_PUBLIC_KEY' на ваш фактический Public Key из EmailJS.
        // Вы можете найти его в разделе "Account" -> "API Keys" в вашей учетной записи EmailJS.
        (function() {
            emailjs.init({
                publicKey: "Q4JqT6qGqR6-xP8d0" // <-- ВАШ ПУБЛИЧНЫЙ КЛЮЧ EmailJS ЗДЕСЬ!
            });
        })();
    </script>
    <style>
        /* Общие стили для динамически добавляемых строк элементов */
        .element-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .element-row input {
            flex: 1;
        }
        .element-row button {
            white-space: nowrap;
        }
        /* Стили для секций анализатора, которые показываются/скрываются */
        .analyzer-section, .conditional-block {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Стили для обязательных полей */
        .required-field::after {
            content: " *";
            color: red;
        }
        /* Стили для контейнера, который используется для генерации PDF (СКРЫТ ДЛЯ ПРОДАКШНА) */
        .pdf-render-container {
            position: fixed;
            top: -9999px; /* Скрываем за пределами экрана */
            left: -9999px;
            width: 210mm; /* Ширина A4 */
            min-height: 297mm; /* Минимальная высота A4 */
            padding: 20mm; /* Отступы для содержимого PDF */
            box-sizing: border-box;
            background: white;
            z-index: -1000; /* За всеми остальными элементами */
            overflow: hidden; /* Скрываем скроллбары */
            opacity: 0; /* Делаем полностью невидимой */
            pointer-events: none; /* Гарантируем отсутствие взаимодействия */
        }

        /* Стили для статических блоков в PDF */
        .pdf-field-display {
            margin-bottom: 4px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f9f9f9;
            font-size: 13px;
        }
        .pdf-h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.25rem;
            font-weight: 500;
        }
        .pdf-section-title {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .pdf-sub-section-title {
             margin-top: 15px;
             margin-bottom: 8px;
             font-size: 1.1rem;
             font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Опросный лист по техпроцессу</h2>
    <form id="form">
        <div id="pdf-content">
            <div class="mb-4">
                <h5>Основные сведения</h5>
                <div class="mb-3">
                    <label for="date" class="form-label required-field">Дата заполнения опросного листа</label>
                    <input type="date" id="date" name="date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="company" class="form-label required-field">Название компании</label>
                    <input type="text" id="company" name="company" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="contact_person" class="form-label">Контактное лицо</label>
                    <input type="text" id="contact_person" name="contact_person" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">Телефон</label>
                    <input type="tel" id="phone" name="phone" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label required-field">Email</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="country" class="form-label">Страна</label>
                    <input type="text" id="country" name="country" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="location" class="form-label">Местонахождение</label>
                    <input type="text" id="location" name="location" class="form-control">
                </div>
            </div>

            <div class="mb-3">
                <label for="material" class="form-label required-field">Тип анализируемого материала</label>
                <select id="material" name="material" class="form-select" required>
                    <option value="">Выберите...</option>
                    <option value="pulp">Пульпа (1–3 потока для анализа)</option>
                    <option value="sinter">Шихта / руда</option>
                    <option value="multiplex">Пульпа с мультиплексором</option>
                    <option value="courier">Пульпа с мультиплексором (на замену анализатора Курьер)</option>
                </select>
            </div>

            <div id="section-pulp" class="analyzer-section">
                <h5>Пульпа: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="pulp_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Характеристика подачи питания</label>
                    <select name="pulp_feed_type" id="feed_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="naporny">Напорный</option>
                        <option value="samotek">Самотек</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Диаметр</label>
                    <input type="text" name="pulp_diameter" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Материал (нерж. сталь, резиновая футеровка и т.д.)</label>
                    <input type="text" name="pulp_material_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление нагнетания / Угол разгрузки</label>
                    <input type="text" name="pulp_pressure_angle" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="pulp_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="pulp_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="pulp_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="pulp_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="pulp_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="pulp_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_pulp" name="xrf_lab_pulp">
                        <label class="form-check-label" for="xrf_lab_pulp">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_pulp" name="personnel_access_pulp">
                        <label class="form-check-label" for="personnel_access_pulp">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_pulp" name="local_network_pulp">
                        <label class="form-check-label" for="local_network_pulp">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_pulp">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_pulp" name="installation_location_pulp">

                        <label class="form-label" for="installation_photo_pulp">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_pulp" name="installation_photo_pulp" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_pulp" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_pulp">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_pulp" name="water_composition_pulp">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_pulp" name="video_surveillance_pulp">
                        <label class="form-check-label" for="video_surveillance_pulp">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-sinter" class="analyzer-section">
                <h5>Шихта / руда: оборудование</h5>
                <div class="mb-3">
                    <label class="form-label">Рассматриваются анализаторы</label>
                    <select name="sinter_analyzer_type" class="form-select">
                        <option value="">Выберите...</option>
                        <option value="arp-1c">АРП-1Ц</option>
                        <option value="arp-2c">АРП-2Ц</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Скорость ленты (м/с)</label>
                    <input type="text" name="sinter_belt_speed" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Нагрузка на ленте (тонн/час, мин/макс)</label>
                    <input type="text" name="sinter_belt_load" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="sinter-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('sinter-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="sinter_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="sinter_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="sinter_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в шихте</label>
                    <input type="text" name="sinter_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_sinter" name="xrf_lab_sinter">
                        <label class="form-check-label" for="xrf_lab_sinter">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_sinter" name="personnel_access_sinter">
                        <label class="form-check-label" for="personnel_access_sinter">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_sinter" name="local_network_sinter">
                        <label class="form-check-label" for="local_network_sinter">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_sinter">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_sinter" name="installation_location_sinter">

                        <label class="form-label" for="installation_photo_sinter">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_sinter" name="installation_photo_sinter" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_sinter" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_sinter" name="video_surveillance_sinter">
                        <label class="form-check-label" for="video_surveillance_sinter">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-multiplex" class="analyzer-section">
                <h5>Пульпа с мультиплексором</h5>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="multiplex_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Расстояния между точками</label>
                    <input type="text" name="multiplex_distances" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Тип трубы и её характеристики (диаметр)</label>
                    <input type="text" name="multiplex_pipe_type" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Давление в трубопроводе</label>
                    <input type="text" name="multiplex_pressure" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="multiplex_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="multiplex-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="multiplex-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('multiplex-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Размер кусков (макс/сред), мм</label>
                    <input type="text" name="multiplex_grain_size" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="multiplex_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="multiplex_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов</label>
                    <input type="text" name="multiplex_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="multiplex_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="multiplex_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_multiplex" name="xrf_lab_multiplex">
                        <label class="form-check-label" for="xrf_lab_multiplex">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_multiplex" name="personnel_access_multiplex">
                        <label class="form-check-label" for="personnel_access_multiplex">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_multiplex" name="local_network_multiplex">
                        <label class="form-check-label" for="local_network_multiplex">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_multiplex">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_multiplex" name="installation_location_multiplex">

                        <label class="form-label" for="installation_photo_multiplex">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_multiplex" name="installation_photo_multiplex" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_multiplex" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_multiplex">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_multiplex" name="water_composition_multiplex">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_multiplex" name="video_surveillance_multiplex">
                        <label class="form-check-label" for="video_surveillance_multiplex">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>

            <div id="section-courier" class="analyzer-section">
                <h5>Пульпа с мультиплексором (на замену Курьер)</h5>
                <div class="mb-3">
                    <label class="form-label">Наличие существующей системы отбора/доставки проб (Courier, MOG или иная)</label>
                    <input type="text" name="courier_existing_system" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Планируется ли подключение к существующему мультиплексору</label>
                    <input type="text" name="courier_connection_plan" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Количество точек для анализа</label>
                    <input type="number" name="courier_streams" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Температура окружающей среды (мин/макс)</label>
                    <input type="text" name="courier_temperature" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Анализируемые элементы от Ca до U + диапазон концентраций</h5>
                    <div id="courier-elements-ca-u"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-elements-ca-u')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <h5>Анализ легких химических элементов</h5>
                    <div id="courier-light-elements"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addElementRow('courier-light-elements')">+ Добавить элемент</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Плотность</label>
                    <input type="text" name="courier_density" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Время измерения (мин/сред/макс), сек</label>
                    <input type="text" name="courier_measurement_time" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Наличие тяжёлых металлов в пульпе</label>
                    <input type="text" name="courier_heavy_metals" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Состав жидкой фазы</label>
                    <input type="text" name="courier_liquid_phase" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Перечень используемых реагентов</label>
                    <input type="text" name="courier_reagents" class="form-control">
                </div>
                <div class="mb-3">
                    <h5>Дополнительные условия</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="xrf_lab_courier" name="xrf_lab_courier">
                        <label class="form-check-label" for="xrf_lab_courier">Наличие РФА-лаборатории на предприятии</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="personnel_access_courier" name="personnel_access_courier">
                        <label class="form-check-label" for="personnel_access_courier">Допуск персонала к источникам</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="local_network_courier" name="local_network_courier">
                        <label class="form-check-label" for="local_network_courier">Наличие локальной сети</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="installation_location_courier">Местонахождение установки</label>
                        <input type="text" class="form-control mb-2" id="installation_location_courier" name="installation_location_courier">

                        <label class="form-label" for="installation_photo_courier">Загрузите фото местонахождения (JPG, PNG)</label>
                        <input type="file" class="form-control mb-2" id="installation_photo_courier" name="installation_photo_courier" accept=".jpg,.jpeg,.png,image/jpeg,image/png">

                        <img id="installation_preview_courier" alt="Превью изображения" style="max-width: 100%; height: auto; display: none; border: 1px solid #ccc; margin-top: 10px;" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="water_composition_courier">Состав оборотной воды</label>
                        <input type="text" class="form-control" id="water_composition_courier" name="water_composition_courier">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="video_surveillance_courier" name="video_surveillance_courier">
                        <label class="form-check-label" for="video_surveillance_courier">Наличие видеонаблюдения</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 mt-4">
            <!-- New checkboxes for attachment control -->
            <div class="form-check attachment-checkbox">
                <input class="form-check-input" type="checkbox" id="sendPdf" checked>
                <label class="form-check-label" for="sendPdf">Отправить PDF вложение</label>
            </div>

            <button id="submit-button" type="button" class="btn btn-primary">Отправить</button>
        </div>
        <div class="mt-3">
            <small class="text-muted"><span style="color: red;">*</span> - обязательные поля</small>
        </div>
    </form>

    <iframe id="pdf-preview" style="width: 100%; height: 500px; margin-top: 20px; display: none;"></iframe>

    <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>

</div>

<script>
    // Идентификаторы EmailJS. Замените их на свои, полученные после настройки EmailJS.
    // Если вы не видите эти ключи, это нормально, пока вы не настроите EmailJS.
    // Они будут использоваться в функции submitForm.
    const EMAILJS_SERVICE_ID = 'service_1rnpxea'; // Ваш Service ID из EmailJS
    const EMAILJS_TEMPLATE_ID = 'template_sk137ts'; // Ваш Template ID из EmailJS (для вашей формы)
    const APPS_SCRIPT_RECIPIENT_EMAIL = 'YOUR_APPS_SCRIPT_EMAIL_ADDRESS_HERE'; // <-- ВАЖНО: Email адрес, который вы получите из Google Apps Script!

    const dynamicElementData = {};

    function saveDynamicValues(containerId) {
        const data = [];
        document.querySelectorAll(`#${containerId} .element-row`).forEach(row => {
            const inputs = row.querySelectorAll("input");
            if (inputs.length >= 2) {
                data.push({
                    element: inputs[0].value || '',
                    range: inputs[1].value || ''
                });
            }
        });
        dynamicElementData[containerId] = data;
    }

    function restoreDynamicValues(containerId) {
        const container = document.getElementById(containerId);
        if (!dynamicElementData[containerId]) return;

        container.innerHTML = ""; // Очищаем, чтобы восстановить
        dynamicElementData[containerId].forEach(entry => {
            const wrapper = document.createElement("div");
            wrapper.className = "element-row";

            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.placeholder = "Элемент (напр. Fe)";
            inputElement.name = `${containerId}_element[]`;
            inputElement.className = "form-control";
            inputElement.value = entry.element;
            inputElement.oninput = () => saveDynamicValues(containerId);

            const inputRange = document.createElement("input");
            inputRange.type = "text";
            inputRange.placeholder = "Диапазон концентрации";
            inputRange.name = `${containerId}_range[]`;
            inputRange.className = "form-control";
            inputRange.value = entry.range;
            inputRange.oninput = () => saveDynamicValues(containerId);

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-outline-danger btn-sm";
            removeBtn.textContent = "Удалить";
            removeBtn.onclick = () => {
                wrapper.remove();
                saveDynamicValues(containerId);
            };

            wrapper.appendChild(inputElement);
            wrapper.appendChild(inputRange);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);

        });
    }

    const containers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"]')).map(el => el.id);

    function showAnalyzerSection(materialType) {
        const sections = document.querySelectorAll('.analyzer-section');
        sections.forEach(section => section.style.display = 'none');

        const selectedSection = document.getElementById(`section-${materialType}`);
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }
    }

    function bindPhotoPreview(materialType) {
        const input = document.getElementById(`installation_photo_${materialType}`);
        const preview = document.getElementById(`installation_preview_${materialType}`);

        if (!input || !preview) return;

        input.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                    input.dataset.jpeg = e.target.result; // Сохраняем Data URL для PDF
                    console.log(`Image Data URL for ${materialType}:`, e.target.result.substring(0, 100) + '...'); // Log a portion of the data URL
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = "none";
                preview.src = "";
                input.dataset.jpeg = ""; // Очищаем Data URL
                console.log(`Image cleared for ${materialType}`);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const materialSelect = document.getElementById("material");
        if (materialSelect) {
            materialSelect.addEventListener("change", () => {
                showAnalyzerSection(materialSelect.value);
                containers.forEach(restoreDynamicValues);
            });
            showAnalyzerSection(materialSelect.value);
            containers.forEach(restoreDynamicValues);
        }

        ["pulp", "sinter", "multiplex", "courier"].forEach(bindPhotoPreview);

        const submitBtn = document.getElementById("submit-button");
        if (submitBtn) {
            submitBtn.addEventListener("click", async (event) => {
                event.preventDefault();
                await submitForm();
            });
        }
    });

    async function blobToBase64(blob) {
        console.log("blobToBase64: Starting conversion.");
        if (!blob) {
            console.error("blobToBase64: Input blob is null or undefined.");
            return null;
        }
        if (!(blob instanceof Blob)) {
            console.error("blobToBase64: Input is not a Blob object. Type:", typeof blob);
            return null;
        }
        console.log("blobToBase64: Blob size:", blob.size, "bytes");

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                console.log("blobToBase64: FileReader result (Data URL start):", reader.result ? String(reader.result).substring(0, 100) + '...' : 'null or empty');
                const base64String = reader.result ? String(reader.result).split(',')[1] : null; // Ensure result is string before split
                if (!base64String) {
                    console.error("blobToBase64: Base64 string is empty or null after splitting.");
                    resolve(null); 
                    return;
                }
                console.log("blobToBase64: Conversion complete. Base64 length:", base64String.length);
                resolve(base64String);
            };
            reader.onerror = (error) => {
                console.error("blobToBase64: FileReader error:", error);
                reject(error); 
            };
            reader.readAsDataURL(blob);
        });
    }

    // Эта функция больше не используется.
    function generateExcelBlob() {
        const form = document.getElementById("form");
        const material = form.material.value;
        const dataRows = [];
        const push = (label, val) => dataRows.push([label, val || "—"]);

        push("Дата", form.date.value);
        push("Компания", form.company.value);
        push("Контактное лицо", form.contact_person.value);
        push("Телефон", form.phone.value);
        push("Email", form.email.value);
        push("Страна", form.country.value);
        push("Отчет от", form.location.value);
        push("Тип материала", material);

        const section = document.getElementById(`section-${material}`);
        if (section) {
            section.querySelectorAll("input, select, textarea").forEach(input => {
                if (input.type === "file" || input.tagName === 'BUTTON') return;

                const labelElement = input.closest(".mb-3")?.querySelector("label") || input.closest(".form-check")?.querySelector("label");
                const label = labelElement ? labelElement.textContent?.trim().replace('*', '') : input.name;
                const value = input.type === "checkbox" ? (input.checked ? "Да" : "Нет") : input.value;
                push(label, value);
            });
        }

        const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);

        allDynamicContainers.forEach(id => {
            saveDynamicValues(id);
            const dynamicElements = dynamicElementData[id];
            if (dynamicElements && dynamicElements.length > 0) {
                push(`--- Элементы из ${id} ---`, "");
                dynamicElements.forEach(entry => {
                    push(`Элемент: ${entry.element || '—'}`, `Диапазон: ${entry.range || '—'}`);
                });
            }
        });

        const worksheet = XLSX.utils.aoa_to_sheet(dataRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Опросный лист");
        const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    }

    async function generatePDFBlob() {
        console.log("generatePDFBlob: Starting PDF content generation.");
        const form = document.getElementById("form");
        const materialType = form.material.value;

        // Создаем контейнер, который будет содержать HTML для PDF
        let pdfRenderContainer = document.getElementById('debug-pdf-render-container');
        if (!pdfRenderContainer) {
            pdfRenderContainer = document.createElement('div');
            pdfRenderContainer.id = 'debug-pdf-render-container'; // Добавляем ID для легкого поиска
            pdfRenderContainer.className = 'pdf-render-container';
            document.body.appendChild(pdfRenderContainer);
            console.log("generatePDFBlob: pdfRenderContainer created and appended to body.");
        } else {
            console.log("generatePDFBlob: pdfRenderContainer already exists, reusing.");
        }
        
        pdfRenderContainer.innerHTML = ''; // Очищаем от отладочных сообщений
        console.log("generatePDFBlob: pdfRenderContainer cleared.");

        // Добавляем статическую тестовую строку для отладки рендеринга
        const testParagraph = document.createElement('p');
        testParagraph.textContent = 'Тестовая строка для PDF. Если вы это видите, рендеринг работает.';
        testParagraph.style.color = 'blue';
        testParagraph.style.fontSize = '16px';
        pdfRenderContainer.appendChild(testParagraph);

        // Добавляем заголовок формы
        const formTitle = document.createElement('h2');
        formTitle.className = 'pdf-section-title';
        formTitle.textContent = 'Опросный лист по техпроцессу';
        pdfRenderContainer.appendChild(formTitle);
        console.log("generatePDFBlob: Form title added.");

        // --- Обработка основных сведений ---
        const mainInfoSection = document.createElement('div');
        mainInfoSection.className = 'mb-4';
        const mainInfoTitle = document.createElement('h5');
        mainInfoTitle.className = 'pdf-h5';
        mainInfoTitle.textContent = 'Основные сведения';
        mainInfoSection.appendChild(mainInfoTitle);
        
        const mainFields = [
            { id: 'date', label: 'Дата заполнения опросного листа', type: 'text' },
            { id: 'company', label: 'Название компании', type: 'text' },
            { id: 'contact_person', label: 'Контактное лицо', type: 'text' },
            { id: 'phone', label: 'Телефон', type: 'text' },
            { id: 'email', label: 'Email', type: 'text' },
            { id: 'country', label: 'Страна', type: 'text' },
            { id: 'location', label: 'Местонахождение', type: 'text' }
        ];

        mainFields.forEach(field => {
            const inputElement = document.getElementById(field.id);
            if (inputElement) {
                const displayDiv = document.createElement('div');
                displayDiv.className = 'pdf-field-display';
                displayDiv.innerHTML = `<strong>${field.label.replace('*', '').trim()}:</strong> ${inputElement.value || '—'}`;
                mainInfoSection.appendChild(displayDiv);
            } else {
                console.warn(`generatePDFBlob: Main field element not found: ${field.id}`);
            }
        });
        pdfRenderContainer.appendChild(mainInfoSection);
        console.log("generatePDFBlob: Main info fields processed.");

        // --- Тип анализируемого материала ---
        const materialSelect = document.getElementById('material');
        if (materialSelect) {
            const displayDiv = document.createElement('div');
            displayDiv.className = 'pdf-field-display';
            displayDiv.innerHTML = `<strong>Тип анализируемого материала:</strong> ${materialSelect.options[materialSelect.selectedIndex]?.text || '—'}`;
            pdfRenderContainer.appendChild(displayDiv);
        } else {
            console.warn("generatePDFBlob: Material select element not found.");
        }
        console.log("generatePDFBlob: Material type processed.");

        // --- Обработка секции анализатора ---
        const activeSectionId = `section-${materialType}`;
        const activeSection = document.getElementById(activeSectionId);

        if (activeSection) {
            const sectionTitle = document.createElement('h5');
            sectionTitle.className = 'pdf-section-title';
            sectionTitle.textContent = activeSection.querySelector('h5')?.textContent || 'Детали анализатора';
            pdfRenderContainer.appendChild(sectionTitle);
            console.log(`generatePDFBlob: Active section (${materialType}) title added.`);

            // Собираем все поля из активной секции
            activeSection.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'hidden' || el.tagName === 'BUTTON') {
                    return;
                }

                const displayDiv = document.createElement('div');
                displayDiv.className = 'pdf-field-display';

                const labelElement = el.closest('.mb-3')?.querySelector('label') || el.closest('.form-check')?.querySelector('label');
                const labelText = labelElement ? labelElement.textContent.trim().replace('*', '') : el.name; // Fallback to name if no label

                if (el.type === 'checkbox') {
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${el.checked ? 'Да' : 'Нет'}`;
                } else if (el.type === 'file') {
                    const originalFileInput = document.getElementById(el.id);
                    const fileName = originalFileInput && originalFileInput.files && originalFileInput.files.length > 0 ? originalFileInput.files[0].name : '—';
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${fileName}`;
                    
                    const jpegData = originalFileInput ? originalFileInput.dataset?.jpeg : null;
                    if (jpegData) {
                        const img = document.createElement('img');
                        img.src = jpegData;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.marginTop = '5px';
                        img.style.border = '1px solid #ddd';
                        img.style.pageBreakInside = 'avoid';
                        pdfRenderContainer.appendChild(img);
                        console.log(`generatePDFBlob: Image for ${el.id} added.`);
                    } else {
                        console.log(`generatePDFBlob: No image data for file input ${el.id}`);
                    }
                } else if (el.tagName === 'SELECT') {
                    const originalSelect = document.getElementById(el.id);
                    const selectedText = originalSelect ? originalSelect.options[originalSelect.selectedIndex]?.text : '—';
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${selectedText}`;
                } else {
                    displayDiv.innerHTML = `<strong>${labelText}:</strong> ${el.value || '—'}`;
                }
                pdfRenderContainer.appendChild(displayDiv);
            });
            console.log("generatePDFBlob: Active section fields processed.");

            // Обработка динамических элементов (Ca до U, легкие элементы)
            activeSection.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"]').forEach(originalDynamicContainer => {
                saveDynamicValues(originalDynamicContainer.id);
                const dynamicElements = dynamicElementData[originalDynamicContainer.id];

                if (dynamicElements && dynamicElements.length > 0) {
                    const dynamicSectionTitle = document.createElement('h5');
                    dynamicSectionTitle.className = 'pdf-sub-section-title';
                    dynamicSectionTitle.textContent = originalDynamicContainer.previousElementSibling?.textContent || 'Элементы';
                    pdfRenderContainer.appendChild(dynamicSectionTitle);
                    console.log(`generatePDFBlob: Dynamic section title added for ${originalDynamicContainer.id}.`);

                    dynamicElements.forEach(entry => {
                        const elementDiv = document.createElement('div');
                        elementDiv.className = 'pdf-field-display';
                        elementDiv.textContent = `Элемент: ${entry.element || '—'}, Диапазон: ${entry.range || '—'}`;
                        pdfRenderContainer.appendChild(elementDiv);
                    });
                    console.log(`generatePDFBlob: Dynamic elements for ${originalDynamicContainer.id} processed.`);
                } else {
                    console.log(`generatePDFBlob: No dynamic elements found for ${originalDynamicContainer.id}.`);
                }
            });
        } else {
            console.warn(`generatePDFBlob: Active section with ID ${activeSectionId} not found.`);
        }
        
        // Логируем HTML-содержимое, которое будет захвачено для PDF
        console.log("generatePDFBlob: InnerHTML of pdfRenderContainer before html2pdf:", pdfRenderContainer.innerHTML.substring(0, 500) + '...');


        // Настройка опций для html2pdf
        const opt = {
            filename: 'oprosny_list.pdf',
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                logging: true,
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' , margin: [10, 10, 10, 10] }, 
        };

        let pdfBlob = null;
        try {
            console.log("generatePDFBlob: Starting html2pdf generation.");
            await new Promise(resolve => setTimeout(resolve, 300));
            pdfBlob = await html2pdf().set(opt).from(pdfRenderContainer).outputPdf('blob');
            console.log("generatePDFBlob: html2pdf generation completed.");
            if (pdfBlob) {
                console.log(`generatePDFBlob: PDF Blob generated! Size: ${pdfBlob.size} bytes.`);
            } else {
                console.error("generatePDFBlob: PDF Blob is NULL! Something went wrong with html2pdf generation.");
                alert("Ошибка: PDF Blob равен NULL. Проверьте консоль на ошибки html2pdf.");
            }
        } catch (error) {
            console.error("generatePDFBlob: Error during html2pdf generation:", error);
            alert(`Ошибка при генерации PDF: ${error.message}. Проверьте консоль.`);
            return null;
        } finally {
            if (document.body.contains(pdfRenderContainer)) {
                document.body.removeChild(pdfRenderContainer);
                console.log("generatePDFBlob: pdfRenderContainer removed from DOM.");
            }
        }
        return pdfBlob;
    }

    async function submitForm() {
        console.log("submitForm: Function started.");
        const form = document.getElementById("form");
        const emailInput = form.email;
        const materialSelect = form.material;
        const errorMessageDiv = document.getElementById("error-message");
        const sendPdfCheckbox = document.getElementById("sendPdf");

        errorMessageDiv.style.display = 'none';
        errorMessageDiv.textContent = '';
        emailInput.classList.remove('is-invalid');
        materialSelect.classList.remove('is-invalid');

        if (!form.checkValidity()) {
            errorMessageDiv.textContent = "Пожалуйста, заполните все обязательные поля формы.";
            errorMessageDiv.style.display = 'block';
            form.reportValidity();
            console.log("submitForm: Form validation failed.");
            return;
        }
        console.log("submitForm: Form validation passed.");

        const email = emailInput.value;
        const material = materialSelect.value;

        let pdfBase64 = ''; // Initialize as empty string
        let installationPhotoDataUrl = ''; // Initialize as empty string
        let excelBase64 = ''; // Для Excel файла

        try {
            // Collect all form data for EmailJS template
            let templateParams = {};
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name && element.tagName !== 'BUTTON') {
                    if (element.type === 'file') {
                        // Файлы будут обрабатываться отдельно как вложения
                        continue; 
                    } else if (element.type === 'checkbox') {
                        templateParams[element.name] = element.checked ? "Да" : "Нет";
                    } else if (element.tagName === 'SELECT') {
                         templateParams[element.name] = element.options[element.selectedIndex]?.text || element.value || '';
                    }
                    else {
                        templateParams[element.name] = element.value;
                    }
                }
            }
            console.log("submitForm: General form data collected for EmailJS.");

            // Add dynamic elements data as stringified JSON
            const allDynamicContainers = Array.from(document.querySelectorAll('div[id$="elements-ca-u"], div[id$="light-elements"], div[id$="sinter-elements-ca-u"], div[id$="multiplex-elements-ca-u"], div[id$="multiplex-light-elements"], div[id$="courier-elements-ca-u"], div[id$="courier-light-elements"]')).map(el => el.id);
            allDynamicContainers.forEach(id => {
                saveDynamicValues(id); // Ensure latest dynamic values are saved
                const dynamicElements = dynamicElementData[id];
                if (dynamicElements && dynamicElements.length > 0) {
                    templateParams[id] = JSON.stringify(dynamicElements); 
                } else {
                    templateParams[id] = 'Нет данных'; // Если нет динамических элементов
                }
            });
            console.log("submitForm: Dynamic elements data collected for EmailJS.");

            // Get installation photo data for attachment
            const currentMaterialSection = document.querySelector(`.analyzer-section[style*="block"]`);
            if (currentMaterialSection) {
                const photoInput = currentMaterialSection.querySelector('input[type="file"]');
                if (photoInput && photoInput.dataset.jpeg) {
                    installationPhotoDataUrl = photoInput.dataset.jpeg;
                    console.log("submitForm: Photo Data URL to be sent:", installationPhotoDataUrl.substring(0, 100) + '...');
                } else {
                    console.log("submitForm: No photo data or photo input found for current section.");
                }
            } else {
                console.warn("submitForm: No active material section found.");
            }

            // Generate PDF if selected
            if (sendPdfCheckbox.checked) {
                console.log("submitForm: sendPdfCheckbox is checked. Calling generatePDFBlob.");
                try {
                    const generatedPdfBlob = await generatePDFBlob();
                    if (generatedPdfBlob) {
                        const convertedBase64 = await blobToBase64(generatedPdfBlob);
                        if (convertedBase64 && convertedBase64.length > 0) {
                            pdfBase64 = convertedBase64;
                            console.log("submitForm: PDF Base64 generated. Length:", pdfBase64.length);
                        } else {
                            console.error("submitForm: PDF Base64 is null or empty after conversion. PDF will not be attached.");
                            alert("Внимание: PDF-файл не был сгенерирован (конвертация в Base64 не удалась). Он не будет прикреплен к письму.");
                            pdfBase64 = ''; 
                        }
                    } else {
                        console.error("submitForm: generatePDFBlob returned null. PDF will not be attached.");
                        alert("Внимание: PDF-файл не был сгенерирован. Он не будет прикреплен к письму.");
                        pdfBase64 = ''; 
                    }
                } catch (pdfGenError) {
                    console.error("submitForm: Error during PDF generation or Base64 conversion:", pdfGenError);
                    alert(`Внимание: Ошибка при генерации PDF: ${pdfGenError.message}. Он не будет прикреплен к письму.`);
                    pdfBase64 = ''; 
                }
            } else {
                console.log("submitForm: sendPdfCheckbox is NOT checked. Skipping PDF generation.");
                pdfBase64 = ''; 
            }

            // Генерация Excel Blob и конвертация в Base64
            console.log("submitForm: Calling generateExcelBlob to prepare Excel attachment.");
            const generatedExcelBlob = generateExcelBlob(); // Используем синхронную функцию
            if (generatedExcelBlob) {
                const convertedExcelBase64 = await blobToBase64(generatedExcelBlob);
                if (convertedExcelBase64 && convertedExcelBase64.length > 0) {
                    excelBase64 = convertedExcelBase64;
                    console.log("submitForm: Excel Base64 generated. Length:", excelBase64.length);
                } else {
                    console.error("submitForm: Excel Base64 is null or empty after conversion. Excel will not be attached.");
                    alert("Внимание: Excel-файл не был сгенерирован (конвертация в Base64 не удалась). Он не будет прикреплен к письму.");
                    excelBase64 = '';
                }
            } else {
                console.error("submitForm: generateExcelBlob returned null. Excel will not be attached.");
                alert("Внимание: Excel-файл не был сгенерирован. Он не будет прикреплен к письму.");
                excelBase64 = '';
            }

            // --- Отправка через EmailJS ---
            console.log("submitForm: Attempting to send data via EmailJS.");

            // Параметры для шаблона EmailJS.
            // to_email - это email, на который будет отправлено письмо.
            // Мы передадим специальный email-адрес Apps Script, который будет обрабатывать письмо.
            const emailJsTemplateParams = {
                to_email: APPS_SCRIPT_RECIPIENT_EMAIL, // <-- Очень важно: это будет email Apps Script
                from_company: templateParams.company || 'N/A',
                from_email: templateParams.email || 'N/A',
                from_date: templateParams.date || 'N/A',
                
                // Чтобы отправить все данные формы в текстовом виде в теле письма,
                // мы сериализуем templateParams (которая содержит все поля)
                // и передадим ее как один параметр в шаблон.
                full_form_data: JSON.stringify(templateParams, null, 2), // Отправляем все данные формы как JSON строку
            };

            // Собираем вложения
            const attachments = [];
            if (pdfBase64 && sendPdfCheckbox.checked) {
                attachments.push({
                    name: "Опросный лист.pdf",
                    data: pdfBase64,
                    type: "application/pdf"
                });
            }
            if (excelBase64) { // Excel всегда прикрепляем, если сгенерирован
                attachments.push({
                    name: "Опросный лист.xlsx",
                    data: excelBase64,
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                });
            }
            if (installationPhotoDataUrl) {
                // EmailJS принимает Base64 без "data:image/..." префикса
                const base64Content = installationPhotoDataUrl.split(',')[1];
                let photoMimeType = 'image/png'; // По умолчанию
                if (installationPhotoDataUrl.startsWith('data:image/jpeg')) {
                    photoMimeType = 'image/jpeg';
                }
                attachments.push({
                    name: "Фото местонахождения.png", // Или .jpg
                    data: base64Content,
                    type: photoMimeType
                });
            }

            await emailjs.send(
                EMAILJS_SERVICE_ID,
                EMAILJS_TEMPLATE_ID,
                emailJsTemplateParams,
                { attachments: attachments }
            );

            alert("Опросный лист успешно отправлен на ваш Email!");
            console.log("submitForm: EmailJS отправка завершена.");

            // Здесь можно очистить форму после успешной отправки
            form.reset();
            showAnalyzerSection(''); // Скрыть все секции
            containers.forEach(id => {
                document.getElementById(id).innerHTML = ''; // Очистить динамические элементы
                dynamicElementData[id] = []; // Очистить сохраненные данные
            });
            document.querySelectorAll('img[id^="installation_preview_"]').forEach(img => {
                img.style.display = 'none';
                img.src = '';
            });

        } catch (err) {
            console.error("submitForm: Критическая ошибка при отправке формы через EmailJS:", err);
            errorMessageDiv.textContent = `Критическая ошибка: ${err.message || "Неизвестная ошибка."} Пожалуйста, попробуйте еще раз или обратитесь в поддержку EmailJS.`;
            errorMessageDiv.style.display = 'block';
        }
    }

    function addElementRow(containerId) {
        const container = document.getElementById(containerId);
        const wrapper = document.createElement("div");
        wrapper.className = "element-row";

        const inputElement = document.createElement("input");
        inputElement.type = "text";
        inputElement.placeholder = "Элемент (напр. Fe)";
        inputElement.name = `${containerId}_element[]`;
        inputElement.className = "form-control";
        inputElement.value = "";
        inputElement.oninput = () => saveDynamicValues(containerId);

        const inputRange = document.createElement("input");
        inputRange.type = "text";
        inputRange.placeholder = "Диапазон концентрации";
        inputRange.name = `${containerId}_range[]`;
        inputRange.className = "form-control";
        inputRange.value = "";
        inputRange.oninput = () => saveDynamicValues(containerId);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
            removeBtn.className = "btn btn-outline-danger btn-sm";
            removeBtn.textContent = "Удалить";
            removeBtn.onclick = () => {
                wrapper.remove();
                saveDynamicValues(containerId);
            };

            wrapper.appendChild(inputElement);
            wrapper.appendChild(inputRange);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);

            saveDynamicValues(containerId);
        }

        window.addElementRow = addElementRow;
    </script>
</body>
</html>
```

### **Шаг 2: Создайте НОВУЮ Google Таблицу и Apps Script для обработки Email**

**Пожалуйста, создайте АБСОЛЮТНО новую таблицу и скрипт, чтобы избежать любых старых кэшированных разрешений.**

1.  **Создайте НОВУЮ Google Таблицу:**
    * Откройте Google Диск (drive.google.com).
    * Нажмите **`+ Создать`** (New) -> **`Google Таблицы`** (Google Sheets).
    * Назовите её, например, **"Данные Опросного Листа - Email"**.
    * **Вставьте ЗАГОЛОВКИ СТОЛБЦОВ** из артефакта `google-sheet-column-headers` в первую строку новой таблицы. Это очень важно для корректного сопоставления данных. Убедитесь, что все заголовки скопированы правильно.

2.  **Откройте НОВЫЙ редактор Apps Script:**
    * В этой **новой** Google Таблице перейдите в меню **`Расширения`** (Extensions) -> **`Apps Script`**.
    * Откроется новая вкладка с **абсолютно новым, пустым проектом Apps Script**. Назовите его, например, "Обработчик писем формы".

3.  **Вставьте КОД Google Apps Script для обработки Email:**
    * Удалите весь существующий код в этом новом проекте.
    * Вставьте следующий код в `Code.gs`:


```javascript
// Этот скрипт получает электронные письма, отправленные EmailJS,
// парсит данные формы из тела письма (включая Base64 вложения)
// и записывает их в активную Google Таблицу.

function processIncomingFormEmail(e) {
  Logger.log("Email received! Subject: " + e.subject);
  Logger.log("Email body (plain text): " + e.plainBody);

  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  var rowData = [];
  rowData.push(new Date()); // Отметка времени

  try {
    // 1. Попытка извлечь JSON строку с полными данными формы из тела письма
    var jsonStartIndex = e.plainBody.indexOf("Полные данные формы (JSON):\n");
    var formData = {};

    if (jsonStartIndex !== -1) {
      var jsonString = e.plainBody.substring(jsonStartIndex + "Полные данные формы (JSON):\n".length);
      // Очищаем JSON строку от любых лишних символов, добавленных шаблоном (например, ```json)
      jsonString = jsonString.trim();
      if (jsonString.startsWith('```json')) {
        jsonString = jsonString.substring('```json'.length);
      }
      if (jsonString.endsWith('```')) {
        jsonString = jsonString.substring(0, jsonString.length - '```'.length);
      }
      jsonString = jsonString.trim();

      formData = JSON.parse(jsonString);
      Logger.log("Successfully parsed JSON data from email body: " + JSON.stringify(formData));
    } else {
      Logger.log("Could not find 'full_form_data' JSON in email body. Attempting to parse direct fields.");
      // Если JSON не найден, попытаемся извлечь основные поля напрямую
      // Это менее надежно, но может сработать для простых писем
      formData.company = (e.plainBody.match(/Компания:\s*(.*)/) || ['', ''])[1].trim();
      formData.email = (e.plainBody.match(/Email отправителя:\s*(.*)/) || ['', ''])[1].trim();
      formData.date = (e.plainBody.match(/Дата заполнения:\s*(.*)/) || ['', ''])[1].trim();
      // Вы можете добавить больше парсеров RegExp для других полей, если необходимо
      Logger.log("Parsed basic fields from email body: " + JSON.stringify(formData));
    }

    // 2. Запись данных в Google Таблицу
    for (var i = 1; i < headers.length; i++) { // Начинаем с 1, так как 0-й столбец - это Timestamp
      var header = headers[i];
      var value = formData[header]; // Получаем значение из разобранных данных формы

      if (value !== undefined && value !== null) {
        // Специальная обработка для JSON строк динамических элементов
        if (header.includes('-elements') && typeof value === 'string' && value.startsWith('[')) {
          // Это уже строковый JSON, сохраняем как есть
          rowData.push(value);
        }
        // Base64 вложения НЕ будут в formData, они будут в e.attachments.
        // Поэтому для полей base64 в таблице мы будем записывать заметку о прикреплении
        else if (header.endsWith('_base64')) {
            var attachmentExists = false;
            if (header === 'pdf_attachment_base64' && e.attachments) {
                attachmentExists = e.attachments.some(att => att.getName() === 'Опросный лист.pdf');
            } else if (header === 'excel_attachment_base64' && e.attachments) {
                attachmentExists = e.attachments.some(att => att.getName() === 'Опросный лист.xlsx');
            } else if (header === 'installation_photo_base64' && e.attachments) {
                attachmentExists = e.attachments.some(att => att.getName().startsWith('Фото местонахождения.'));
            }
            rowData.push(attachmentExists ? 'Прикреплено к письму' : 'Нет вложения');
        }
        else {
          rowData.push(value);
        }
      } else {
        rowData.push(''); // Если поле отсутствует или равно null
      }
    }
    sheet.appendRow(rowData);
    Logger.log("Data successfully written to Google Sheet.");

    // 3. Обработка вложений (опционально: сохранение на Google Drive)
    if (e.attachments && e.attachments.length > 0) {
      Logger.log("Processing " + e.attachments.length + " attachments from email.");
      // Пример: сохранение вложений на Google Drive
      // var targetFolderId = "ВАШ_ID_ПАПКИ_GOOGLE_DRIVE"; // Замените на ID папки, куда сохранять
      // var folder = DriveApp.getFolderById(targetFolderId);
      // for (var j = 0; j < e.attachments.length; j++) {
      //   var attachment = e.attachments[j];
      //   Logger.log("Saving attachment: " + attachment.getName());
      //   folder.createFile(attachment);
      // }
    }

  } catch (error) {
    Logger.log("Error in processIncomingFormEmail: " + error.toString() + ". Full event: " + JSON.stringify(e));
  }
}
